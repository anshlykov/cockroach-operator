# CockroachDB Kubernetes Operator

The CockroachDB Kubernetes Operator deploys CockroachDB on a Kubernetes cluster. You can use the Operator to manage the configuration of a running CockroachDB cluster, including:

- Authenticating certificates
- Configuring resource requests and limits
- Scaling the cluster
- Performing a rolling upgrade

## Limitations

- This project is in alpha and is not production-ready.
- The Operator currently runs on GKE.
- Currently the Kubernetes CA is required to deploy a secure cluster.
- Expansion of persistent volumes is not yet functional.

## Prerequisites

- [Docker](https://docs.docker.com/get-docker/)
- [kustomize](https://kustomize.io/)

## Install the Operator

Clone this repo:

```
git clone https://github.com/cockroachdb/cockroach-operator.git
```

From the `cockroach-operator` directory on your machine, create a Kubernetes cluster on GKE, specifying a cluster name (e.g., `crdb-test`).

```
./hack/create-gke-cluster.sh -c <cluster-name>
```

This creates a Kubernetes cluster on GKE, using your default GCP region and project.

Install the Operator, specifying the cluster name:

```
./hack/apply-operator.sh -c <cluster-name>
```

Validate that the Operator is running:

```
kubectl get pods

NAME                                  READY   STATUS    RESTARTS   AGE
cockroach-operator-6f7b86ffc4-9ppkv   1/1     Running   0          54s
```

## Start CockroachDB

Download [`opconfig.yaml`](https://github.com/cockroachdb/cockroach-operator/manifests/opconfig.yaml) and optionally modify this configuration as below.

```
curl -OOOOOOOOO https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/manifests/opconfig.yaml
```

By default `opconfig.yaml` tells the Operator to create a secure cluster. For local testing, you can optionally deploy an insecure cluster. Exclude the following line from the configuration and skip the [Certificate signing](#certificate-signing) section below.

```
  tlsEnabled: true
```

An insecure cluster is suitable for *testing purposes only* and should not be used on production.

### Certificate signing

`tlsEnabled: true` tells the Operator to generate and approve 1 client and 1 node certificate for the cluster, using the built-in Kubernetes CA.

> This differs from the way CockroachDB handles [node authentication](https://www.cockroachlabs.com/docs/stable/authentication.html#using-digital-certificates-with-cockroachdb), in which each CockroachDB node has its own node certificate. Using the Operator, one node certificate is currently used to authenticate the cluster.

<!-- If you wish to use a non-Kubernetes CA, additionally enable the following lines in `opconfig.yaml` and fill in the names of the corresponding node and client secrets:

```
nodeTLSSecret: <node-secret>
clientTLSSecret: <client-secret>
```

For example, if you are using [`cockroach cert`](https://www.cockroachlabs.com/docs/stable/cockroach-cert.html) to generate certificates, use these secret names:

```
nodeTLSSecret: cockroachdb.node
clientTLSSecret: cockroachdb.client.root
``` -->

### Set resource requests and limits

Before deploying, we recommend explicitly allocating CPU and memory to CockroachDB in the Kubernetes pods. This is done in the `resources.requests` object in `opconfig.yaml`. For example:

```
resources:
  requests:
    cpu: "16"
    memory: "8Gi"
  limits:
    memory: "8Gi"
```

### Create the StatefulSet

Apply `opconfig.yaml`:

```
kubectl create -f opconfig.yaml
```

Check that the pods were created:

```
kubectl get pods
```

```
NAME                                  READY   STATUS    RESTARTS   AGE
cockroach-operator-6f7b86ffc4-9t9zb   1/1     Running   0          3m22s
cockroachdb-0                         1/1     Running   0          2m31s
cockroachdb-1                         1/1     Running   1          102s
cockroachdb-2                         1/1     Running   0          46s
```

Each pod should have `READY` status soon after being created.

## Access the SQL shell

Launch a pod that runs indefinitely with the `cockroach` binary. <!-- Depending on how you authenticated the cluster: -->

- Kubernetes CA:

	```
	kubectl create -f https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/manifests/client-secure.yaml
	```

	Approve the certificate signing request generated by Kubernetes:

	```
	kubectl certificate approve default.client.root
	```
	
<!-- - Non-Kubernetes CA:

	If you didn't use `cockroach cert` to generate the client certificate, substitute an appropriate `secretName` before applying this file:

	```
	kubectl create -f https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/manifests/client-secure-byoc.yaml
	``` -->

You can then access the SQL shell and run SQL statements from this pod:

```
kubectl exec -it cockroachdb-client-secure -- ./cockroach sql --certs-dir=/cockroach-certs --host=cockroachdb-public
```

If you deployed an insecure cluster, you can access the SQL shell directly:

```
kubectl run cockroachdb -it --image=cockroachdb/cockroach:v20.1.4 --rm --restart=Never -- sql --insecure --host=cockroachdb
```

If you want to [access the Admin UI](#access-the-admin-ui), create a SQL user with a password while you're here:

```
CREATE USER roach WITH PASSWORD 'Q7gc8rEdS';
```

```
\q
```

## Access the Admin UI

To access the cluster's [Admin UI](https://www.cockroachlabs.com/docs/v20.1/admin-ui-overview), port-forward from your local machine to one of the pods:

```
kubectl port-forward cockroachdb-0 8080
```

Access the Admin UI at `https://localhost:8080`. Note that [certain Admin UI pages](https://www.cockroachlabs.com/docs/v20.1/admin-ui-overview#admin-ui-access) require `admin` access.

## Configure the cluster

You can configure the cluster by modifying and reapplying `opconfig.yaml`.

<!-- ### Expand disk size

To expand persistent volumes, edit `resources.requests.storage`:

```
resources:
  requests:
    storage: 100Gi
```

Apply the new configuration:

```
kubectl apply -f opconfig.yaml
``` -->

### Scale the cluster

To scale the cluster, edit `nodes`:

```
nodes: 4
```

Do **not** scale down to fewer than 3 nodes. This is considered an anti-pattern and will cause errors.

> Note that you must scale by updating the `nodes` value in the Operator configuration. Using `kubectl scale statefulset <cluster-name> --replicas=4` will result in new pods immediately being terminated.

Apply the new configuration:

```
kubectl apply -f opconfig.yaml
```

### Ugprade the cluster

Perform a rolling upgrade by changing the image name:

```
image:
  name: cockroachdb/cockroach:v20.1.4
```

Apply the new configuration:

```
kubectl apply -f opconfig.yaml
```

## Stop the cluster

Remove the Operator:

```
./hack/delete-operator.sh -c <cluster-name>
```

Clean up any resources associated with the `cockroachdb` label:

```
kubectl delete pods,statefulsets,services,persistentvolumeclaims,persistentvolumes,poddisruptionbudget,jobs,rolebinding,clusterrolebinding,role,clusterrole,serviceaccount -l app=cockroachdb
```

Delete the GKE cluster:

```
./hack/delete-gke-cluster.sh -c <cluster-name>
```

Note that this script will trigger but will not wait for cluster deletion to complete.